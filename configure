
#!/bin/bash
# Ricardo L. Gon√ßalves 2021/01 
#
# Simple is better. 
#

#Debug script
#set -xv

# Defaults
WLUA="luajit"
DEBUG=""
MEM=""
#CC="/usr/bin/gcc"
CC=$(which gcc clang | tail -n1)
OPTS="-Wno-format"
#OPTS="-std=c11 -pedantic -Wpedantic"

# pharsing parameters
while [ 1 ]; do
  if [ "X$1" == "X" ] ; then
     break
  fi

  if [ "X$(echo $1| egrep '\-')" != "X" ]; then
    if [ "$1" == "--help" -o "$1" == "-h" -o "$1" == "-help" ] ; then
     echo "Syntax:"
     echo "./configure <parameters> <extra (gcc/clang) parameters>"
     echo ""
     echo "Parameters:"
     echo " -h,-help,--help  - This help message."
     echo " -c,--compiler [gcc|clang]  - Select compiler."
     echo " -d,--debug  - Enable debug mode."
     echo " --no-debug - Disable debug mode."
     echo " -l,--lua [luajit|lua51|lua53]  - Select LUA version."
     echo " -m,--mem # Debug memory leak (sanitizer)."
     echo " --no-mem  - Disable sanitizer memory leak debug."
     echo ""
     echo " * Note: all gcc and clang parameters are supported."
     exit 0
    fi
    
    if [ "$1" == "--lua" -o "$1" == "-l" ] ; then
      shift
      WLUA=$1
      echo set lua WLUA=$WLUA
    fi

    if [ "$1" == "--mem" -o "$1" == "-m" ] ; then
      shift
      MEM="-fsanitize=address -fno-omit-frame-pointer -O3"
      #ASAN_OPTIONS=strict_string_checks=1:detect_stack_use_after_return=1:check_initialization_order=1:strict_init_order=1
      #DEBUG="-g -fsanitize=address -fno-omit-frame-pointer -fsanitize-address-use-after-scope -O3"
    fi

    if [ "$1" == "--no-mem" ] ; then
      shift
      MEM=""
    fi

    if [ "$1" == "--debug" -o "$1" == "-d" ] ; then
      shift
      DEBUG="-g"
    fi

    if [ "$1" == "--no-debug" ] ; then
      shift
      DEBUG=""
    fi

    if [ "$1" == "--compiler" -o "$1" == "-c" ] ; then
      shift
      CC=$(which gcc clang | grep $1)
    fi
    
    if [ "X$(echo $1|egrep '\=')" != "X" ] ; then
      OPTS+=" $1"
      echo 1 set extra options OPTS=$OPTS
    fi

    if [ "X$(echo $1|egrep -v '\='|egrep -v '\-\-'|egrep '\-' )" != "X" ] ; then
      OPTS+=" $1"
      echo 2 set extra options OPTS=$OPTS
      if [ "X$(echo $2|egrep -v '\-' )" != "X" ] ; then
        shift
        OPTS+=" $1"
        echo 3 set extra options OPTS=$OPTS
      fi
    fi

  fi
  shift
done

if [ "$WLUA" == "luajit" ] ; then
   echo "#define WLUAJIT" > compile.h
   XLUA=luajit
   echo set lualib XLUA=$XLUA
fi

if [ "$WLUA" == "lua51" ] ; then
  echo "#define WLUA51" > compile.h
  XLUA=lua51
  echo set lualib XLUA=$XLUA
fi

if [ "$WLUA" == "lua53" ] ; then
  echo "#define WLUA53" > compile.h
  XLUA=lua53
  echo set lualib XLUA=$XLUA
fi


PLIBS="sdl2 SDL2_image SDL2_ttf SDL2_mixer $XLUA"

if [ "X$OPTS" != "X" ]; then
   echo ""
   echo " gcc/clang parameters: $OPTS"
   echo ""
fi
cat<<EOF>config.mk
CC=$CC
CFLAGS= $(pkg-config --cflags $PLIBS) $DEBUG $MEM $OPTS
LIBS=-pthread $(pkg-config --libs $PLIBS) -lm $DEBUG $MEM $OPTS
EOF
make clean
